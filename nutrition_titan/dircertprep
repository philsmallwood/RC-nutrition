###Nutrition Direct Cert Script 
###Script to grab the direct certification files, format them, and upload them to Titan
###Requires bash and sshpass 

###Change to the directory in which the script is running
cd "$(dirname "$(readlink -f "$0")")"

###Set environment 
set -e 

###Variables###
DAY=`date +%Y%m%d`
MONTHYEAR=`date +%b%Y`
REMOTEDIR1="dircert"
KEYLOCAL="/home/philmore/.ssh/.LOCAL"
SERVERLOCAL="10.222.2.70"
KEYREMOTE="/home/philmore/.ssh/.TITAN"
SERVERREMOTE="sftp.titank12.com"
COMBINEDFILE="rc-directcert.csv"
FINALFILE="dircertupload.csv"
ARCHIVEFILE="dircertupload_$MONTHYEAR.csv"
EMPTYFILE="dircertupload_$MONTHYEAR-EMPTY.csv"
LOG="/var/log/scripts/nutrition_directcert_$MONTHYEAR.log"
#Email Variables
TOEMAIL="philip.smallwood@redclay.k12.de.us"
SUBJECT_SUCCESS="The Direct Cert script has completed successfully"
SUBJECT_EMPTY="The Direct Cert file was EMPTY"

###Start Log
echo "---`date`---" >> $LOG
echo "" >> $LOG

###Get Direct Cert Files
sshpass -f $KEYLOCAL sftp philip.smallwood@$SERVERLOCAL <<EOF
cd $REMOTEDIR1
get *.csv
get *.txt
rm *.csv
rm *.txt
exit
EOF

###Log
echo "+ Files downloaded from PCS server" >> $LOG
echo "" >> $LOG

###If Files exits
if ls *.csv > /dev/null
then
	cat *.csv >> $COMBINEDFILE
fi

###Convert the direct cert files from UTF-16 to UTF-8 and combine them into one file
if ls *.txt > /dev/null
then
	for i in *.txt; do
		iconv -f UTF-16 -t UTF-8 $i >> dircertcombined.txt
	done
	tr '\t' ',' < dircertcombined.txt >> $COMBINEDFILE
fi

###Check for empty file
if ([ ! -e *.csv ] && [ ! -e *.txt ])
then
	#Stop, cleanup, log, finish
	echo "+ NO FILES DOWNLOADED!!!" >> $LOG
	echo "+ Finshed " >> $LOG
	echo "" >> $LOG
	echo "------------------" >> $LOG
	#Email and exit
	python3 /usr/local/bin/mailsend.py "$TOEMAIL" "$SUBJECT_EMPTY" "$LOG"
    exit 111


###Drop Title Lines 
sed -i '/District,,,/d' $COMBINEDFILE
sed -i '/School Year/d' $COMBINEDFILE
sed -i '/,,,,,/d' $COMBINEDFILE

###Change To SNAP and TANF based on criteria from Nutrition 
sed -i 's/,Y,Y,/,SNAP,Y,/g' $COMBINEDFILE
sed -i 's/,Y,N,/,SNAP,N,/g' $COMBINEDFILE
sed -i 's/,N,Y,/,TANF,Y,/g' $COMBINEDFILE
sed -i 's/,N,N,/,TANF,N,/g' $COMBINEDFILE

###Fix Date format
sed -i 's/,\ /,/g' $COMBINEDFILE
sed -i 's/\/\ 2/\/01\/2/g' $COMBINEDFILE

###Remove Quotes for 3+ Multi Race students
 sed -i 's/\"Multi-Racial: .*\"/Multi/g' $COMBINEDFILE

###Generate Final File with the 3 pieces of info needed
awk -F',' '{ printf "%06i,%s,%s\n" , $5 , $11 , $19 }' $COMBINEDFILE > $FINALFILE

###Drop header lables
sed -i '/SchoolName,Grade/d' $FINALFILE

###Log
echo "+ File generated for Titan" >> $LOG
echo "" >> $LOG

###Check for empty file
if [ ! -s $FINALFILE  ]
then
	#Stop, cleanup, archive, finish
	echo "+ FILE IS EMPTY!!!" >> $LOG
	mv $FINALFILE $EMPTYFILE
	mv $EMPTYFILE /archive
	rm *.csv *.txt
	#Log
	echo "+ Finshed " >> $LOG
	echo "" >> $LOG
	echo "------------------" >> $LOG
	#Email and exit
	python3 /usr/local/bin/mailsend.py "$TOEMAIL" "$SUBJECT_EMPTY" "$LOG"
    exit 111

###Get Direct Cert Files
sshpass -f $KEYREMOTE sftp -oKexAlgorithms=diffie-hellman-group1-sha1 RCCSD@$SERVERREMOTE <<EOF
put $FINALFILE
exit
EOF

###Log
echo "+ Files sent to Titan" >> $LOG
echo "" >> $LOG

###Cleanup and archive and Finish Log
mv $FINALFILE $ARCHIVEFILE
mv $ARCHIVEFILE /archive
rm *.csv *.txt
#Log
echo "+ Finshed " >> $LOG
echo "" >> $LOG
echo "------------------" >> $LOG

###Email Log Out
python3 /usr/local/bin/mailsend.py "$TOEMAIL" "$SUBJECT_SUCCESS" "$LOG"




